{% extends "base.html" %}

{% block title %}Confirm Checklist{% endblock %}

{% block content %}
  <h2 class="text-xl font-semibold text-gray-700 mb-6">2. Confirm Checklist</h2>

  <div class="mb-4 space-y-1 text-sm text-gray-600">
      <p><strong>File:</strong> {{ original_filename }}</p>
      <p><strong>Municipality:</strong> {{ municipality }}</p>
      <p><strong>LLM Status:</strong> <span class="font-medium {{ 'text-green-600' if llm_status == 'LLM Ready' else 'text-yellow-600' }}">{{ llm_status }}</span></p>
  </div>

  <form method="post" action="{{ url_for('execute_trigger') }}" class="space-y-6">
      <div>
          <label for="chosen_checklist" class="block text-sm font-medium text-gray-700 mb-1">Select Checklist:</label>
          {% if suggested_checklist %}
              <p class="text-sm text-blue-600 mb-2">LLM Suggestion: <strong>{{ suggested_checklist }}</strong></p>
          {% else %}
              <p class="text-sm text-yellow-600 mb-2">LLM could not suggest a checklist. Please select manually.</p>
          {% endif %}

          <select id="chosen_checklist" name="chosen_checklist" required
                   class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
              <option value="" disabled {% if not suggested_checklist %}selected{% endif %}>-- Select a Checklist --</option>
              {% for name in available_checklist_names %}
                  <option value="{{ name }}" {% if name == suggested_checklist %}selected{% endif %}>{{ name }}</option>
              {% endfor %}
          </select>
      </div>

      <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Checklist Description:</label>
          <div id="checklist-description" class="min-h-[60px] border border-gray-200 p-3 bg-gray-50 rounded-md text-sm text-gray-700">
              Loading description...
          </div>
      </div>

      <div class="flex items-center justify-center pt-4 space-x-4">
          <button type="submit"
                  class="inline-flex items-center justify-center px-6 py-2 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50">
              Start Analysis
          </button>
          <a href="{{ url_for('index') }}" class="text-sm text-gray-500 hover:text-gray-700">Cancel</a>
      </div>
  </form>
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='js/confirm.js') }}"></script>
  <script>
      // Pass municipality to JS (ensure this is correct)
      const currentMunicipality = "{{ municipality }}";

      // Initial description load for the selected/suggested checklist
      document.addEventListener('DOMContentLoaded', () => {
          const checklistSelect = document.getElementById('chosen_checklist');
          const descriptionDiv = document.getElementById('checklist-description');
          const initialChecklist = checklistSelect.value;

          if (initialChecklist) {
              // Call fetchDescription from confirm.js
              if (typeof fetchDescription === 'function') {
                  fetchDescription(currentMunicipality, initialChecklist);
              } else {
                   console.error('fetchDescription function not found. Check confirm.js');
                   descriptionDiv.textContent = 'Error loading description script.';
                   descriptionDiv.classList.add('text-red-600'); // Use Tailwind for error color
              }
          } else {
               descriptionDiv.textContent = 'Please select a checklist to see its description.';
               descriptionDiv.classList.remove('text-red-600');
          }
      });
  </script>
{% endblock %}
